<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ComPeteHub</title>
    <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.css">
    <script src="../../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../node_modules/axios/dist/axios.js"></script>
  </head>
  <body>
    <!-- DOCUMENTATION NAVBAR-->
    <nav class="navbar sticky-top navbar-expand-lg" style="background-color: #292c33;">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html" style="color: white">ComPeteHub</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Alles was collapsed werden soll, wenn der Bildschirm kleiner wird-->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          
          <!-- Alles was links in die navabr soll-->
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          </ul>

           <!-- Alles was rechts in die navabr soll-->
           <div class="flex-d">
           </div>
      </div>
    </nav>

    <!--√úberschrift + Beschreibung-->
    <div class="√úberschrift">
      <div class="container mt-5">
        <div class="p-1 text-center bg-body-tertiary rounded-3">
          <h1 class="display-4">Leistungs√ºbersicht</h1>
          <p class="lead"> Hier k√∂nnen aktuelle und vergangene Leistungen des ausgew√§hlten Sportlers angesehen werden. 
            <br> F√ºr Informationen zu einzelnen Leistungen auf die einzelnen Kategorien klicken!</p>          
        </div>
    </div>

    <!--Sportlerinfos Name, etc.-->
    <div class="Sportlerinfos">
      <div class="container my-5">
        <div class="text-center bg-body-tertiary rounded-3">
          <h1 class="display-4" id="sportlerinfos-name"> <b> Vorname Nachname </b>  </h1>
          <p class="lead" id="sportlerinfos-alter-ges"> 99.99.9999 - 99 Jahre - Geschlecht </p> 
        </div>        
      </div>      
    </div>

    <!--Optionen-->
    <!--TODO-->
    <div class="container">
      <div class="d-flex justify-content-center gap-3 align-items-end  ">
        <!-- Button: Leistungen eintragen -->
        <a href="#" onclick="this.href='LeistungErstellen.html?id=' + athleteId" class="text-decoration-none">
          <button class="btn btn-light border border-2 fw-bold py-2 px-3">Leistungen eintragen</button>
        </a>

        <!-- Datum f√ºr Datenabfrage  -->
        <div class="text-center">
          <label for="datenAbfragenAb" class="form-label d-block" >Leistungen anzeigen ab</label>
          <input type="date" class="form-control btn btn-light border border-2 fw-bold py-2 px-3" id="datenAbfragenAb" value="2025-01-01" style="max-width: 180px; font-weight: bold;">
        </div>
    
        <!-- Button: Leistungen bearbeiten -->
        <a href="#" onclick="this.href='LeistungBearbeiten.html?id=' + athleteId" class="text-decoration-none">
          <button class="btn btn-light border border-2 fw-bold py-2 px-3">Leistungen bearbeiten</button>
        </a>    
        
      </div>
    </div>

    <!--Kategorien + Aufklappbare Details-->

    <div class="my-5">
      <!--Kategorie 1 Ausdauer-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Ausdauer-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Ausdauer-tabelle')"> 
              <div id="Ausdauer-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">-</p>
              </div>            
                <h2 class="display-4 position-absolute start-50 translate-middle-x">Ausdauer</h2>  
              <div id="Ausdauer-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">-</p>     
              </div>
            </div>
            <table class="table d-none" id="Ausdauer-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Eintr√§gen bef√ºllt-->
            </table>
        </div>
      </div>

      <!--Kategorie 2 Schnelligkeit-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Schnelligkeit-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Schnelligkeit-tabelle')"> 
              <div id="Schnelligkeit-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">-</p>
              </div>            
              <h2 class="display-4 position-absolute start-50 translate-middle-x">Schnelligkeit</h2>  
              <div id="Schnelligkeit-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">-</p>     
              </div>
            </div>
            <table class="table d-none" id="Schnelligkeit-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Eintr√§gen bef√ºllt-->
            </table>
        </div>
      </div>

      <!--Kategorie 3 Kraft-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Kraft-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Kraft-tabelle')"> 
              <div id="Kraft-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">-</p>
              </div>            
              <h2 class="display-4 position-absolute start-50 translate-middle-x">Kraft</h2>  
              <div id="Kraft-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">-</p>     
              </div>
            </div>
            <table class="table d-none" id="Kraft-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Eintr√§gen bef√ºllt-->
            </table>
        </div>
      </div>

      <!--Kategorie 4 Koordination-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Koordination-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Koordination-tabelle')"> 
              <div id="Koordination-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">-</p>
              </div>            
              <h2 class="display-4 position-absolute start-50 translate-middle-x">Koordination</h2>  
              <div id="Koordination-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">-</p>     
              </div>
            </div>
            <table class="table d-none" id="Koordination-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Eintr√§gen bef√ºllt-->
            </table>
        </div>
      </div>

      

    <script>
      const athleteId = new URLSearchParams(window.location.search).get("id");

      // Lade alles notwendige vor
      document.addEventListener("DOMContentLoaded", async () => {
        // √úberpr√ºfung, ob User angemeldet ist
        try{
          const response = await axios.post('http://localhost:8080/v1/user/start-session', {}, 
          {withCredentials: true});
          // Wenn die Anfrage erfolgreich ist (200 OK), mache weiter
        } catch(error) {
          if (error.response) {
            // Bei Fehler mit Response gehe zu Anmeldung.html
            window.location.href = "Anmeldung.html";
          } else {
            // Andere Fehler
            alert(error.message);
            window.location.href = "Anmeldung.html";
          }
        }      

        try {
          // Daten vom Backend abrufen & vorbereiten
          const response = await axios.get(`http://localhost:8080/v1/athlete/get/${athleteId}`, {
            withCredentials: true,
          });
          const athlete = response.data.athlete;
          var sex = "";
          if (athlete.sex === "m") {
            sex = 'M√§nnlich';
          } else if (athlete.sex === "f") {
            sex = 'Weiblich';
          } else if (athlete.sex === "d") {
            sex = 'Divers';
          }

          //Alter berechnen
          const currentDate = new Date().toJSON().slice(0, 10)          
          var age = currentDate.split('-')[0]-athlete.birth_date.split('T')[0].split('-')[0];
          if((currentDate.split('-')[1]<athlete.birth_date.split('T')[0].split('-')[1]) || (currentDate.split('-')[2]===athlete.birth_date.split('T')[0].split('-')[2])){
            age--;
          }
          const birthdate = athlete.birth_date.split("T")[0].split('-')[2] + '.' + athlete.birth_date.split("T")[0].split('-')[1] + '.' + athlete.birth_date.split("T")[0].split('-')[0];
        
          //Sportlerinfos (Name, Alter, etc.) bef√ºllen
          const sportlerInfoDaten = {"vorname": athlete.first_name, "nachname": athlete.last_name, "geburtstag": birthdate, "alter": age, "geschlecht": sex};
          sportlerInfosF√ºllen(sportlerInfoDaten);

          //Tabellen aller Disziplinen f√ºllen 
          updateAlleKategorieTabellen();
        }
        catch (error) {
          console.error("Fehler beim Laden der Daten:", error);
          alert("Athlet konnte nicht geladen werden.");
        }
      })


      //Beim √§ndern des DatenabfragenAb-Input alle Tabellen aktualisieren
      document.getElementById("datenAbfragenAb").addEventListener("input", async function () {
        await updateAlleKategorieTabellen();
      });
      
      async function updateAlleKategorieTabellen(){
        /*
        Aktualisiert die 4 Tabellen + Kopfzeilen, wenn Datum Abfrage ab wann ge√§ndert wird. 
        */

        //Performance-Eintr√§ge ab dem Wert vom Dateinput abfragen
        let performanceEintr√§ge = [];
        try{
          const abrufenAb = document.getElementById("datenAbfragenAb").value
          const responsePerformance =  await axios.get(`http://localhost:8080/v1/performance/get-all/${athleteId}?since=${abrufenAb}`, {
            withCredentials: true});        
          performanceEintr√§ge = responsePerformance.data.performance_entries
        }catch (error){          
          console.error("Fehler beim Abrufen der Performances:", error);
        }
          
        //Kategorien f√ºr sp√§tere Zuordnung bekommen
        let alleKategorien = [] 
        try{
        const responseDisziplinen =  await axios.get(`http://localhost:8080/v1/discipline/get-all`, {
          withCredentials: true});          
        alleKategorien = responseDisziplinen.data.discipline_names
        }
        catch (error){
          console.error("Fehler beim Abrufen der Disziplinen." , error)
        }

        try{
          //Alle Kategorien durchgehen und Kopfzeilen + Tabellen f√ºllen
          let alleExercisesF√ºrAktKategorie = []
          for (const aktKategorie of alleKategorien) {
            try {
              const responseExercises = await axios.get(`http://localhost:8080/v1/exercise/get/${aktKategorie}`, {
                withCredentials: true
              });
              
              alleExercisesF√ºrAktKategorie = responseExercises.data.exercises

            } catch (error) {
              //irgendwas beim Abrufen und/oder Eintragen in Felder fehlgeschlagen
              console.error(`Fehler beim Abrufen der √úbungen f√ºr ${element}:`, error);
            }
            
            //Tabelleninhalte leeren, um danach neu hinzuzuf√ºgen (sonst doppelte Eintr√§ge)         
            let tab = document.getElementById(`${aktKategorie}-tabelle`)
            tab.innerHTML = `<tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>  `

            //F√ºr jede Kategorie die Performanceeintr√§ge durchgehen & wenn passende Exercise gefunden (weil Name + Einheit ben√∂tigt) alles eintragen
            //So ein bisschen umst√§ndlich, da bei performances der Name + Einheit fehlt, aber gebraucht wird... 
            let kopfzeileGef√ºllt = false;
            for (let  performance of performanceEintr√§ge){
              for (let exercise of alleExercisesF√ºrAktKategorie){
                if (exercise.exercise_id == performance.exercise_id){
                  try{ 
                    
                    const datum_formattiert = performance.date.split("T")[0].split('-')[2] + '.' + performance.date.split("T")[0].split('-')[1] + '.' + performance.date.split("T")[0].split('-')[0];
                    let neueTabZeile = {"disziplin": exercise.name, "datum": datum_formattiert, 
                                      "wert": `${performance.points} ${exercise.unit}`, "medaille": performance.medal} 
                    tabelleF√ºllen(`${aktKategorie}-tabelle`, [neueTabZeile]); //!!! schauen, ob Kategorien von backend mit Id von HTML-Elementen √ºbereinstimmen
                    
                    // Nur beim ersten Exercise die Kopfzeile f√ºllen
                    if (!kopfzeileGef√ºllt) {
                      kategorieKopfzeileF√ºllen(`${aktKategorie}-kopfzeile-gesamt`, {
                          "wert": `${performance.points} ${exercise.unit}`,
                          "medaille": performance.medal
                      });
                      kopfzeileGef√ºllt = true; // Markiere, dass die Kopfzeile gef√ºllt wurde
                    }
                  }
                  catch (error){} //Wenn Kategoriename nicht als Tabelle existiert/gefunden wurde... 

                  break;
                }
              }  
            }
          }
        }
        catch (error){
          console.error("Fehler beim Einsortieren der Performances.", error);
        }
      
      }
      


      function sportlerInfosF√ºllen(daten){
        /*
        Name, Alter, ... beim Laden der Seite f√ºllen.
        */
        const divName = document.getElementById("sportlerinfos-name");
        const divAlterGes = document.getElementById("sportlerinfos-alter-ges");    

        divName.innerHTML = `<b> ${daten["vorname"]} ${daten["nachname"]} </b>`;
        divAlterGes.innerHTML = `<p> ${daten["geburtstag"]} - ${daten["alter"]} Jahre - ${daten["geschlecht"]}</p>`

      }
      
      
      function kategorieKopfzeileF√ºllen(id, daten){
        /*
        F√ºr die Kategorien die letzten Werte + Medaille bef√ºllen.
        */
        const div = document.getElementById(id)

        const pWerte = div.getElementsByClassName("wert")
        pWerte[0].innerHTML = daten["wert"]

        //Medaille zu Icon
        let aktMed;
        switch (daten["medaille"]){
          case "gold": 
            aktMed = "ü•á"; 
            break;
          case "silver": 
            aktMed = "ü•à";
            break;
          case "bronze": 
            aktMed = "ü•â";
            break
          default: 
            aktMed = "‚ùå";
        }
        pWerte[1].innerHTML = aktMed;
        }

      
      function toggleDetails(id) {
        /*
        Tabellen mit Infos anzeigen/verbergen
        */
        let details = document.getElementById(id); 
        details.classList.toggle("d-none");
      }
      
      
      function tabelleF√ºllen(id, daten){
        /*
        F√ºgt den jeweiligen Kategorie-Tabellen die Daten hinzu.
        */
        const table = document.getElementById(id);

        for (let i =0; i<daten.length; i++){ //alle Daten durchgehen           
          //in Zellen packen, die in eine Zeile und die dann am Ende in Tabelle
          let row = table.insertRow(-1);
          let cell1 = row.insertCell(0);
          let cell2 = row.insertCell(1);
          let cell3 = row.insertCell(2);
          let cell4 = row.insertCell(3);

          cell1.innerHTML = daten[i]["disziplin"];
          cell2.innerHTML = daten[i]["datum"];
          cell3.innerHTML = daten[i]["wert"];

          
          //Medaille von Text zu Emoji
          let aktMed;
          switch (daten[i]["medaille"]){
            case "gold": 
              aktMed = "ü•á"; 
              break;
            case "silver": 
              aktMed = "ü•à";
              break;
            case "bronze": 
              aktMed = "ü•â";
              break
            default: 
              aktMed = "‚ùå";

          }
          cell4.innerHTML = aktMed;
          
        }
      }      
      
    </script>
  </body>
</html>