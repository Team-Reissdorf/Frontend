<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ComPeteHub</title>
  <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.css">
  <script src="../../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../../node_modules/axios/dist/axios.js"></script>
</head>
<body>
    <script src="../js/Navigation.js"></script> <!-- Navbar laden & einfügen -->

    <!--Überschrift + Beschreibung-->
    <div class="Überschrift">
      <div class="container mt-5">
        <div class="p-1 text-center bg-body-tertiary rounded-3">
          <h1 class="display-4">Leistungsübersicht</h1>
          <p class="lead"> Hier können aktuelle und vergangene Leistungen des ausgewählten Sportlers angesehen werden. 
            <br> Für Informationen zu einzelnen Leistungen auf die einzelnen Kategorien klicken!</p>          
        </p>
      </div>
    </div>

    <!--Sportlerinfos Name, etc.-->
    <div class="Sportlerinfos">
      <div class="container my-5">
        <div class="text-center bg-body-tertiary rounded-3">
          <h1 class="display-4" id="sportlerinfos-name"> <b> Vorname Nachname </b> </h1>
          <p class="lead" id="sportlerinfos-alter-ges"> 99.99.9999 - 99 Jahre - Geschlecht </p>
        </div>
      </div>
    </div>

    <!--Optionen-->
    <!--TODO-->
    <div class="container">
      <div class="d-flex justify-content-center gap-3 align-items-end  ">
        <!-- Button: Leistungen eintragen -->
        <a href="#" onclick="this.href='LeistungErstellen.html?id=' + athleteId" class="text-decoration-none">
          <button class="btn btn-light border border-2 fw-bold py-2 px-3">Leistungen eintragen</button>
        </a>

        <!-- Datum für Datenabfrage  -->
        <div class="text-center">
          <label for="datenAbfragenAb" class="form-label d-block">Leistungen anzeigen ab</label>
          <input type="date" class="form-control btn btn-light border border-2 fw-bold py-2 px-3" id="datenAbfragenAb"
            value="2025-01-01" max="9999-12-31" style="max-width: 180px; font-weight: bold;">
        </div>

        <!-- Button: Leistungen bearbeiten -->
        <a href="#" onclick="this.href='LeistungBearbeiten.html?id=' + athleteId" class="text-decoration-none">
          <button class="btn btn-light border border-2 fw-bold py-2 px-3">Leistungen bearbeiten</button>
        </a>

      </div>
    </div>

    <!--Kategorien + Aufklappbare Details-->

    <div class="my-5">
      <!--Kategorie 1 Ausdauer-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">
          <div id="Ausdauer-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center "
            onclick="toggleDetails('Ausdauer-tabelle')">
            <div id="Ausdauer-kopfzeile-lW" class="flex-shrink-0 text-center" style="width: 20vmin;">
              <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
            <h2 class="display-4 position-absolute start-50 translate-middle-x">Ausdauer</h2>
            <div id="Ausdauer-kopfzeile-m" class="flex-shrink-0" style="width: 20vmin;">
              <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
          </div>
          <table class="table d-none" id="Ausdauer-tabelle">
            <tr>
              <th>Übung</th>
              <th>Datum</th>
              <th>Wert</th>
              <th>Medaille</th>
            </tr>
            <!-- wird mit passenden Einträgen befüllt-->
          </table>
        </div>
      </div>

      <!--Kategorie 2 Schnelligkeit-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">
          <div id="Schnelligkeit-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center "
            onclick="toggleDetails('Schnelligkeit-tabelle')">
            <div id="Schnelligkeit-kopfzeile-lW" class="flex-shrink-0 text-center" style="width: 20vmin;">
              <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
            <h2 class="display-4 position-absolute start-50 translate-middle-x">Schnelligkeit</h2>
            <div id="Schnelligkeit-kopfzeile-m" class="flex-shrink-0" style="width: 20vmin;">
              <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
          </div>
          <table class="table d-none" id="Schnelligkeit-tabelle">
            <tr>
              <th>Übung</th>
              <th>Datum</th>
              <th>Wert</th>
              <th>Medaille</th>
            </tr>
            <!-- wird mit passenden Einträgen befüllt-->
          </table>
        </div>
      </div>

      <!--Kategorie 3 Kraft-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">
          <div id="Kraft-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center "
            onclick="toggleDetails('Kraft-tabelle')">
            <div id="Kraft-kopfzeile-lW" class="flex-shrink-0 text-center" style="width: 20vmin;">
              <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
            <h2 class="display-4 position-absolute start-50 translate-middle-x">Kraft</h2>
            <div id="Kraft-kopfzeile-m" class="flex-shrink-0" style="width: 20vmin;">
              <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
          </div>
          <table class="table d-none" id="Kraft-tabelle">
            <tr>
              <th>Übung</th>
              <th>Datum</th>
              <th>Wert</th>
              <th>Medaille</th>
            </tr>
            <!-- wird mit passenden Einträgen befüllt-->
          </table>
        </div>
      </div>

      <!--Kategorie 4 Koordination-->
      <div class="container my-3">
        <div class="p-2 text-center bg-body-tertiary rounded-3">
          <div id="Koordination-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center "
            onclick="toggleDetails('Koordination-tabelle')">
            <div id="Koordination-kopfzeile-lW" class="flex-shrink-0 text-center" style="width: 20vmin;">
              <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
            <h2 class="display-4 position-absolute start-50 translate-middle-x">Koordination</h2>
            <div id="Koordination-kopfzeile-m" class="flex-shrink-0" style="width: 20vmin;">
              <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 3vmin;">-</p>
            </div>
          </div>
          <table class="table d-none" id="Koordination-tabelle">
            <tr>
              <th>Übung</th>
              <th>Datum</th>
              <th>Wert</th>
              <th>Medaille</th>
            </tr>
            <!-- wird mit passenden Einträgen befüllt-->
          </table>
        </div>
      </div>



      <script>
        const athleteId = new URLSearchParams(window.location.search).get("id");

        // Lade alles notwendige vor
        document.addEventListener("DOMContentLoaded", async () => {
          // Überprüfung, ob User angemeldet ist
          try {
            const response = await axios.post('http://localhost:8080/v1/user/start-session', {},
              { withCredentials: true });
            // Wenn die Anfrage erfolgreich ist (200 OK), mache weiter
          } catch (error) {
            if (error.response) {
              // Bei Fehler mit Response gehe zu Anmeldung.html
              window.location.href = "Anmeldung.html";
            } else {
              //Falls Server nicht erreichbar ist
              if(error.code == "ERR_NETWORK"){
                console.error("Backend nicht erreichbar:" + error)
                window.location.href = "BackendDown.html";
              } else {
                // Andere Fehler
                console.error("Fehler: " + error)
              }
            }
          }

          try {
            // Daten vom Backend abrufen & vorbereiten
            const response = await axios.get(`http://localhost:8080/v1/athlete/get/${athleteId}`, {
              withCredentials: true,
            });
            const athlete = response.data.athlete;
            var sex = "";
            if (athlete.sex === "m") {
              sex = 'Männlich';
            } else if (athlete.sex === "f") {
              sex = 'Weiblich';
            } else if (athlete.sex === "d") {
              sex = 'Divers';
            }

            //Alter berechnen
            const currentDate = new Date().toJSON().slice(0, 10)
            var age = currentDate.split('-')[0] - athlete.birth_date.split('T')[0].split('-')[0];
            if ((currentDate.split('-')[1] < athlete.birth_date.split('T')[0].split('-')[1]) || (currentDate.split('-')[2] === athlete.birth_date.split('T')[0].split('-')[2])) {
              age--;
            }
            const birthdate = athlete.birth_date.split("T")[0].split('-')[2] + '.' + athlete.birth_date.split("T")[0].split('-')[1] + '.' + athlete.birth_date.split("T")[0].split('-')[0];

            //Sportlerinfos (Name, Alter, etc.) befüllen
            const sportlerInfoDaten = { "vorname": athlete.first_name, "nachname": athlete.last_name, "geburtstag": birthdate, "alter": age, "geschlecht": sex };
            sportlerInfosFüllen(sportlerInfoDaten);

            //Tabellen aller Disziplinen füllen 
            updateAlleKategorieTabellen();
          }
          catch (error) {
            console.error("Fehler beim Laden der des Athleten:", error);
            alert("Athlet existiert nicht.");
            window.location.href = "../index.html"; //falsche athleteID in URL -> zurück zur Übersicht
          }
        })


        //Beim ändern des DatenabfragenAb-Input alle Tabellen aktualisieren
        document.getElementById("datenAbfragenAb").addEventListener("input", async function () {
          await updateAlleKategorieTabellen();
        });

        async function updateAlleKategorieTabellen() {
          /*
          Aktualisiert die 4 Tabellen + Kopfzeilen, wenn Datum Abfrage ab wann geändert wird. 
          */

          //Performance-Einträge ab dem Wert vom Dateinput abfragen
          let performanceEinträge = [];
          try {
            const abrufenAb = document.getElementById("datenAbfragenAb").value;

            const responsePerformance = await axios.get(`http://localhost:8080/v1/performance/get-all/${athleteId}?since=${abrufenAb}`, {
              withCredentials: true
            });
            performanceEinträge = responsePerformance.data.performance_entries
          } catch (error) {
            if (error.response) {
              if (error.response.status === 401) {
                window.location.href = "Anmeldung.html";
              }

              else {
                console.error("Fehler beim Abrufen der Performances:", error);
                alert("Fehler beim Abrufen der Performance-Einträge.")
              }
            }
          }

          //Kategorien für spätere Zuordnung bekommen
          let alleKategorien = []
          try {
            const responseDisziplinen = await axios.get(`http://localhost:8080/v1/discipline/get-all`, {
              withCredentials: true
            });
            alleKategorien = responseDisziplinen.data.discipline_names
          }
          catch (error) {
            if (error.response.status === 401) {
              window.location.href = "Anmeldung.html";
            }
            else {
              console.error("Fehler beim Abrufen der Disziplinen.", error)
              alert("Fehler beim Abrufen der Disziplinen.")
            }
          }

          try {
            //Alle Kategorien durchgehen und Kopfzeilen + Tabellen füllen
            let alleExercisesFürAktKategorie = []
            for (const aktKategorie of alleKategorien) {
              try {
                const responseExercises = await axios.get(`http://localhost:8080/v1/exercise/get/${aktKategorie}`, {
                  withCredentials: true
                });

                alleExercisesFürAktKategorie = responseExercises.data.exercises

              } catch (error) {
                //irgendwas beim Abrufen und/oder Eintragen in Felder fehlgeschlagen

                if (error.response) {
                  if (error.response.status === 401) {
                    window.location.href = "Anmeldung.html";
                  }
                  else {
                    alert("Fehler beim Abrufen der Übungen")
                    console.error(`Fehler beim Abrufen der Übungen für ${element}:`, error);
                  }

                }
              }

              //Tabelleninhalte leeren, um danach neu hinzuzufügen (sonst doppelte Einträge)         
              let tab = document.getElementById(`${aktKategorie}-tabelle`)
              tab.innerHTML = `<tr>
                <th>Übung</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>  `

              //Leeren/Zurücksetzen der Kopfzeilen
              const kopfZ = document.getElementById(`${aktKategorie}-kopfzeile-gesamt`)
              const pWerte = kopfZ.getElementsByClassName("wert")
              pWerte[0].innerHTML = "-"
              pWerte[1].innerHTML = "-"

              //Für jede Kategorie die Performanceeinträge durchgehen & wenn passende Exercise gefunden (weil Name + Einheit benötigt) alles eintragen
              //So ein bisschen umständlich, da bei performances der Name + Einheit fehlt, aber gebraucht wird... 
              let kopfzeileGefüllt = false;
              for (let performance of performanceEinträge) {
                for (let exercise of alleExercisesFürAktKategorie) {
                  if (exercise.exercise_id == performance.exercise_id) {
                    try {

                      const datum_formattiert = performance.date.split("T")[0].split('-')[2] + '.' + performance.date.split("T")[0].split('-')[1] + '.' + performance.date.split("T")[0].split('-')[0];
                      let neueTabZeile = {
                        "uebung": exercise.name, "datum": datum_formattiert,
                        "wert": `${performance.points} ${exercise.unit}`, "medaille": performance.medal
                      }
                      tabelleFüllen(`${aktKategorie}-tabelle`, [neueTabZeile]); //!!! schauen, ob Kategorien von backend mit Id von HTML-Elementen übereinstimmen

                      // Nur beim ersten Exercise die Kopfzeile füllen
                      if (!kopfzeileGefüllt) {
                        kategorieKopfzeileFüllen(`${aktKategorie}-kopfzeile-gesamt`, {
                          "wert": `${performance.points} ${exercise.unit}`,
                          "medaille": performance.medal
                        });
                        kopfzeileGefüllt = true; // Markiere, dass die Kopfzeile gefüllt wurde
                      }
                    }
                    catch (error) { } //Wenn Kategoriename nicht als Tabelle existiert/gefunden wurde...

                    break;
                  }
                }
              }
            }
          }
          catch (error) {
            console.error("Fehler beim Einsortieren der Performances.", error);
          }

        }



        function sportlerInfosFüllen(daten) {
          /*
          Name, Alter, ... beim Laden der Seite füllen.
          */
          const divName = document.getElementById("sportlerinfos-name");
          const divAlterGes = document.getElementById("sportlerinfos-alter-ges");

          divName.innerHTML = `<b> ${daten["vorname"]} ${daten["nachname"]} </b>`;
          divAlterGes.innerHTML = `<p> ${daten["geburtstag"]} - ${daten["alter"]} Jahre - ${daten["geschlecht"]}</p>`

        }


        function kategorieKopfzeileFüllen(id, daten) {
          /*
          Für die Kategorien die letzten Werte + Medaille befüllen.
          */
          const div = document.getElementById(id)

          const pWerte = div.getElementsByClassName("wert")
          pWerte[0].innerHTML = daten["wert"]

          //Medaille zu Icon
          let aktMed;
          switch (daten["medaille"]) {
            case "gold":
              aktMed = "🥇";
              break;
            case "silver":
              aktMed = "🥈";
              break;
            case "bronze":
              aktMed = "🥉";
              break
            default:
              aktMed = "❌";
          }
          pWerte[1].innerHTML = aktMed;
        }


        function toggleDetails(id) {
          /*
          Tabellen mit Infos anzeigen/verbergen
          */
          let details = document.getElementById(id);
          details.classList.toggle("d-none");
        }


        function tabelleFüllen(id, daten) {
          /*
          Fügt den jeweiligen Kategorie-Tabellen die Daten hinzu.
          */
          const table = document.getElementById(id);

          for (let i = 0; i < daten.length; i++) { //alle Daten durchgehen           
            //in Zellen packen, die in eine Zeile und die dann am Ende in Tabelle
            let row = table.insertRow(-1);
            let cell1 = row.insertCell(0);
            let cell2 = row.insertCell(1);
            let cell3 = row.insertCell(2);
            let cell4 = row.insertCell(3);

            cell1.innerHTML = daten[i]["uebung"];
            cell2.innerHTML = daten[i]["datum"];
            cell3.innerHTML = daten[i]["wert"];


            //Medaille von Text zu Emoji
            let aktMed;
            switch (daten[i]["medaille"]) {
              case "gold":
                aktMed = "🥇";
                break;
              case "silver":
                aktMed = "🥈";
                break;
              case "bronze":
                aktMed = "🥉";
                break
              default:
                aktMed = "❌";

            }
            cell4.innerHTML = aktMed;

          }
        }

      </script>
</body>

</html>