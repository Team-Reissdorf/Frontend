<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ComPeteHub</title>
    <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.css">
    <script src="../../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../node_modules/axios/dist/axios.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <!-- DOCUMENTATION NAVBAR-->
    <nav class="navbar sticky-top navbar-expand-lg" style="background-color: #292c33;">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html" style="color: white">ComPeteHub</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Alles was collapsed werden soll, wenn der Bildschirm kleiner wird-->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          
          <!-- Alles was links in die navabr soll-->
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          </ul>

           <!-- Alles was rechts in die navabr soll-->
           <div class="flex-d">
           </div>
      </div>
    </nav>

    <!--Überschrift + Beschreibung-->
    <div class="Überschrift">
      <div class="container mt-5">
        <div class="p-1 text-center bg-body-tertiary rounded-3">
          <h1 class="display-4">Leistungsübersicht</h1>
          <p class="lead"> Hier können aktuelle und vergangene Leistungen des ausgewählten Sportlers angesehen werden. 
            <br> Für weitere Informationen auf die einzelnen Kategorien klicken!</p>          
        </div>
    </div>

    <!--Sportlerinfos Name, etc.-->
    <div class="Sportlerinfos">
      <div class="container my-5">
        <div class="text-center bg-body-tertiary rounded-3">
          <h1 class="display-4" id="sportlerinfos-name"> <b> Vorname Nachname </b>  </h1>
          <p class="lead" id="sportlerinfos-alter-ges"> 99.99.9999 - 99 Jahre - Geschlecht </p> 
        </div>        
      </div>      
    </div>

    <!--Optionen-->
    <!--TODO-->
    <div class="container">
      <div class="d-flex justify-content-center gap-3 align-items-end  ">
        <!-- Button: Leistungen eintragen -->
        <a href="test.html" class="text-decoration-none ">
          <button class="btn btn-light border border-2 fw-bold py-2 px-3">Leistungen eintragen</button>
        </a>

        <!-- Datum für Datenabfrage  -->
        <div class="text-center">
          <label for="datenAbfragenAb" class="form-label d-block" >Leistungen anzeigen ab</label>
          <input type="date" class="form-control btn btn-light border border-2 fw-bold py-2 px-3" id="datenAbfragenAb" value="2025-01-01" style="max-width: 180px; font-weight: bold;">
        </div>
    
        <!-- Button: Leistungen bearbeiten -->
        <a href="test2.html" class="text-decoration-none">
          <button class="btn btn-light border border-2 fw-bold py-2 px-3">Leistungen bearbeiten</button>
        </a>    
        
      </div>
    </div>

    
    



    <!------------------------------------->
    <!--Kategorien + Aufklappbare Details-->
    <!------------------------------------->

    <div class="my-5">
      <!--Kategorie 1 Ausdauer-->
      <div class="container my-1">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Ausdauer-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Ausdauer-tabelle')"> 
              <div id="Ausdauer-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">999</p>
              </div>            
                <h2 class="display-4 position-absolute start-50 translate-middle-x">Ausdauer</h2>  
              <div id="Ausdauer-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">🛑</p>     
              </div>
            </div>
            <table class="table d-none" id="Ausdauer-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Einträgen befüllt-->
            </table>
        </div>
      </div>

      <!--Kategorie 2 Schnelligkeit-->
      <div class="container my-1">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Schnelligkeit-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Schnelligkeit-tabelle')"> 
              <div id="Schnelligkeit-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">999</p>
              </div>            
              <h2 class="display-4 position-absolute start-50 translate-middle-x">Schnelligkeit</h2>  
              <div id="Schnelligkeit-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">🛑</p>     
              </div>
            </div>
            <table class="table d-none" id="Schnelligkeit-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Einträgen befüllt-->
            </table>
        </div>
      </div>


      <!--Kategorie 3 Kraft-->
      <div class="container my-1">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Kraft-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Kraft-tabelle')"> 
              <div id="Kraft-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">999</p>
              </div>            
              <h2 class="display-4 position-absolute start-50 translate-middle-x">Kraft</h2>  
              <div id="Kraft-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">🛑</p>     
              </div>
            </div>
            <table class="table d-none" id="Kraft-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Einträgen befüllt-->
            </table>
        </div>
      </div>

      <!--Kategorie 4 Koordination-->
      <div class="container my-1">
        <div class="p-2 text-center bg-body-tertiary rounded-3">        
            <div id="Koordination-kopfzeile-gesamt" class="d-flex mx-5 justify-content-between align-items-center " onclick="toggleDetails('Koordination-tabelle')"> 
              <div id="Koordination-kopfzeile-lW" class="flex-shrink-0 text-center"> 
                <h6 class="lead">letzter Wert</h4>
                <p class="wert" style="font-size: 30px;">999</p>
              </div>            
              <h2 class="display-4 position-absolute start-50 translate-middle-x">Koordination</h2>  
              <div id="Koordination-kopfzeile-m" class="flex-shrink-0">  
                <h6 class="lead">letzte Medaille</h4>
                <p class="wert" style="font-size: 30px;">🛑</p>     
              </div>
            </div>
            <table class="table d-none" id="Koordination-tabelle" >
              <tr>
                <th>Disziplin</th>
                <th>Datum</th>
                <th>Wert</th>
                <th>Medaille</th>   
              </tr>                 
              <!-- wird mit passenden Einträgen befüllt-->
            </table>
        </div>
      </div>

      

    <script>

      // Lade alles notwendige vor
      document.addEventListener("DOMContentLoaded", async () => {
        // Überprüfung, ob User angemeldet ist
        try{
          const response = await axios.post('http://localhost:8080/v1/user/start-session', {}, 
          {withCredentials: true});
          // Wenn die Anfrage erfolgreich ist (200 OK), mache weiter
        } catch(error) {
          if (error.response) {
            // Bei Fehler mit Response gehe zu Anmeldung.html
            window.location.href = "Anmeldung.html";
          } else {
            // Andere Fehler
            alert(error.message);
            window.location.href = "Anmeldung.html";
          }
        }      

        try {
          // Daten vom Backend abrufen & vorbereiten
          const athleteId = new URLSearchParams(window.location.search).get("id");
          const response = await axios.get(`http://localhost:8080/v1/athlete/get/${athleteId}`, {
            withCredentials: true,
          });
          const athlete = response.data.athlete;
          var sex = "";
          if (athlete.sex === "m") {
            sex = 'Männlich';
          } else if (athlete.sex === "f") {
            sex = 'Weiblich';
          } else if (athlete.sex === "d") {
            sex = 'Divers';
          }

          //Alter berechnen
          const currentDate = new Date().toJSON().slice(0, 10)          
          var age = currentDate.split('-')[0]-athlete.birth_date.split('T')[0].split('-')[0];
          if((currentDate.split('-')[1]<athlete.birth_date.split('T')[0].split('-')[1]) || (currentDate.split('-')[2]===athlete.birth_date.split('T')[0].split('-')[2])){
            age--;
          }
          const birthdate = athlete.birth_date.split("T")[0].split('-')[2] + '.' + athlete.birth_date.split("T")[0].split('-')[1] + '.' + athlete.birth_date.split("T")[0].split('-')[0];
        
          //Sportlerinfos (Name, Alter, etc.) befüllen
          const sportlerInfoDaten = {"vorname": athlete.first_name, "nachname": athlete.last_name, "geburtstag": birthdate, "alter": age, "geschlecht": sex};
          sportlerInfosFüllen(sportlerInfoDaten);
          
          //Disziplin Kopfzeilen füllen
          //TODO 

          //Tabellen aller Disziplinen füllen 
          updateAlleKategorieTabellen();
        }
        catch (error) {
          console.error("Fehler beim Laden der Daten:", error);
          alert("Athlet konnte nicht geladen werden.");
        }
      })


      //Beim ändern des DatenabfragenAb-Input alle Tabellen aktualisieren
      document.getElementById("datenAbfragenAb").addEventListener("input", async function () {
        await updateAlleKategorieTabellen();
      });
      
      async function updateAlleKategorieTabellen(){
        //Performance-Einträge ab dem Wert vom Dateinput abfragen
        let performanceEinträge = [];
        try{
          const athleteId = new URLSearchParams(window.location.search).get("id");
          const abrufenAb = document.getElementById("datenAbfragenAb").value
          const responsePerformance =  await axios.get(`http://localhost:8080/v1/performance/get-all/${athleteId}?since=${abrufenAb}`, {
            withCredentials: true});        
          performanceEinträge = responsePerformance.data.performance_entries
          console.log(responsePerformance)

        }catch (error){          
          console.error("Fehler beim Abrufen der Performances:", error);
        }
          
        //Kategorien für spätere Zuordnung bekommen
        let alleKategorien = [] 
        try{
        const responseDisziplinen =  await axios.get(`http://localhost:8080/v1/discipline/get-all`, {
          withCredentials: true});          
        alleKategorien = responseDisziplinen.data.discipline_names
        }
        catch (error){
          console.error("Fehler beim Abrufen der Disziplinen." , error)
        }

        try{
          //Alle Kategorien durchgehen und Kopfzeilen + Tabellen füllen
          let alleExercisesFürAktKategorie = []
          for (const aktKategorie of alleKategorien) {
            try {
              const responseExercises = await axios.get(`http://localhost:8080/v1/exercise/get/${aktKategorie}`, {
                withCredentials: true
              });
              
              alleExercisesFürAktKategorie = responseExercises.data.exercises

            } catch (error) {
              //irgendwas beim Abrufen und/oder Eintragen in Felder fehlgeschlagen
              console.error(`Fehler beim Abrufen der Übungen für ${element}:`, error);
            }
            
            //Tabelleninhalte leeren, um danach neu hinzuzufügen         
            let tab = document.getElementById(`${aktKategorie}-tabelle`).getElementsByTagName("tr")
            tab.innerHTML = ""



            //Für jede Kategorie die Performanceeinträge durchgehen & wenn passende Exercise gefunden (weil Name + Einheit benötigt) alles eintragen
            //So ein bisschen umständlich, da bei performances der Name + Einheit fehlt, aber gebraucht wird... 
            
            for (let  performance of performanceEinträge){
              for (let exercise of alleExercisesFürAktKategorie){
                if (exercise.exercise_id == performance.exercise_id){
                  try{ 
                    let neueTabZeile = {"disziplin": exercise.name, "datum": performance.date, 
                                      "wert": `${performance.points} ${exercise.unit}`, "medaille": performance.medal} 
                    tabelleFüllen(`${aktKategorie}-tabelle`, [neueTabZeile]); //!!! schauen, ob Kategorien von backend mit Id von HTML-Elementen übereinstimmen
                    kategorieKopfzeileFüllen(`${aktKategorie}-kopfzeile-gesamt`, {"wert": `${performance.points} ${exercise.unit}`, "medaille": performance.medal});
           
                  }
                  catch (error){} //Wenn Kategoriename nicht als Tabelle existiert/gefunden wurde... 

                  break;

                }

              }  
            }
            
              //Kopfzeile mit letztem Wert füllen
              //!!!nicht sicher, ob wirklich "letzter" Wert...
            //kategorieKopfzeileFüllen(`${aktKategorie}-kopfzeile-gesamt`, {"wert": `${performance.points} ${exercise.unit}`, "medaille": performance.medal});
           
          }
        }
        catch (error){
          console.error("Fehler beim Einsortieren der Performances.", error);
        }

        
      
      }
      

      /*
      //Testaufrufe fürs Befüllen der Kategorie Kopfzeilen + Wertetabellen

      //Kopfzeile pro Kategorie füllen...
      const testKopfDaten = {"wert": "123879m", "medaille":"🥉"};
      const testKopfDaten2 = {"wert": "12s", "medaille":"🥉"};      
      const testKopfDaten3 = {"wert": "1232412134123s", "medaille":"🥉"};

      kategorieKopfzeileFüllen("Ausdauer-kopfzeile-gesamt", testKopfDaten);
      kategorieKopfzeileFüllen("Schnelligkeit-kopfzeile-gesamt", testKopfDaten2);      
      kategorieKopfzeileFüllen("Kraft-kopfzeile-gesamt", testKopfDaten3);
      kategorieKopfzeileFüllen("Koordination-kopfzeile-gesamt", testKopfDaten);
      
      //Tabellen befüllen testen 
      const testDaten = [ {"disziplin": "300m Sprint", "datum": "30.01.2025", "wert": "30,89s", "medaille": "gold"},
                          {"disziplin": "100m Sprint", "datum": "19.01.2025", "wert": "45,89s", "medaille": "bronze"}];
      
      tabelleFüllen("Ausdauer-tabelle", testDaten);
      tabelleFüllen("Schnelligkeit-tabelle", testDaten);   
      tabelleFüllen("Kraft-tabelle", testDaten);
      tabelleFüllen("Koordination-tabelle", testDaten);  

      */
      

      function sportlerInfosFüllen(daten){
        const divName = document.getElementById("sportlerinfos-name");
        const divAlterGes = document.getElementById("sportlerinfos-alter-ges");    

        divName.innerHTML = `<b> ${daten["vorname"]} ${daten["nachname"]} </b>`;
        divAlterGes.innerHTML = `<p> ${daten["geburtstag"]} - ${daten["alter"]} Jahre - ${daten["geschlecht"]}</p>`

      }
      
      //Für die Kategorien die letzten Werte + Medaille befüllen
      function kategorieKopfzeileFüllen(id, daten){
        const div = document.getElementById(id)

        const pWerte = div.getElementsByClassName("wert")
        pWerte[0].innerHTML = daten["wert"]

        let aktMed;
          switch (daten[i]["medaille"]){
            case "gold": 
              aktMed = "🥇"; 
              break;
            case "silver": 
              aktMed = "🥈";
              break;
            case "bronze": 
              aktMed = "🥉";
              break
            default: 
              aktMed = "❌";
          }
        pWerte[1].innerHTML = aktMed;
      }

      //Tabellen mit Infos anzeigen/verbergen
      function toggleDetails(id) {
            let details = document.getElementById(id); 
            details.classList.toggle("d-none");
        }
      

      //Fügt den jeweiligen Kategorie-Tabellen die Daten hinzu.
      function tabelleFüllen(id, daten){
        const table = document.getElementById(id);

        for (let i =0; i<daten.length; i++){ //alle Daten durchgehen           
          //in Zellen packen, die in eine Zeile und die dann am Ende in Tabelle
          let row = table.insertRow(-1);
          let cell1 = row.insertCell(0);
          let cell2 = row.insertCell(1);
          let cell3 = row.insertCell(2);
          let cell4 = row.insertCell(3);

          cell1.innerHTML = daten[i]["disziplin"];
          cell2.innerHTML = daten[i]["datum"];
          cell3.innerHTML = daten[i]["wert"];

          
          //Medaille von Text zu Emoji
          let aktMed;
          switch (daten[i]["medaille"]){
            case "gold": 
              aktMed = "🥇"; 
              break;
            case "silver": 
              aktMed = "🥈";
              break;
            case "bronze": 
              aktMed = "🥉";
              break
            default: 
              aktMed = "❌";

          }
          cell4.innerHTML = aktMed;
          
        }
      }
      
      
    </script>
  </body>
</html>