<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ComPeteHub</title>
    <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.css">
    <script src="../../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../node_modules/axios/dist/axios.js"></script>
  </head>
  <body>
    <!-- DOCUMENTATION NAVBAR-->
    <nav class="navbar sticky-top navbar-expand-lg" style="background-color: #292c33;">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html" style="color: white">ComPeteHub</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Alles was collapsed werden soll, wenn der Bildschirm kleiner wird-->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">

          <!-- Alles was links in die navabr soll-->
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          </ul>

           <!-- Alles was rechts in die navabr soll-->
           <div class="flex-d">
           </div>
      </div>
    </nav>

    <div class="container my-5">
      <div class="p-5 text-center bg-body-tertiary rounded-3">
        <h1 class="text-body-emphasis">Anmelden</h1>
        <p class="lead">Gib deine Email und dein Password unten ein, um dich als Trainer anzumelden!</p>
      </div> <!-- /.jumbotron -->
      <!-- Warnblock wenn Backend nicht erreichbar ist-->
      <div id="alertBox" class="alert alert-warning alert-dismissible fade" role="alert" style="display: none;">
        <strong>Server leider nicht Erreichbar!!</strong> Bitte versuchen Sie es später...
        <div class="position-relative">
        </div>
      </div>
      <br>

      <div class="row justify-content-md-center">
        <div class="col-l-8 col-md-8 col-sm-12">

          <!-- Login-Form -->
          <form id="login-form">

            <!-- Email -->
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" class="form-control" id="email" placeholder="Email" required autocomplete="email">
            </div>

            <!-- Passwort -->
            <div class="form-group">
              <label for="pwd">Passwort</label>
              <input type="password" class="form-control" id="pwd" placeholder="Passwort" required autocomplete="current-password">
            </div>

            <!-- Angemeldet bleiben (Checkbox) -->
             <div class="form-group">
              <label for="remember_me">Angemeldet bleiben?</label>
              <input type="checkbox" name="remember_me" id="remember_me" value="True">
             </div>
            <div class="form-group">
              <div class="row justify-content-md-center">
                <button type="submit" class="btn btn-light" style="width: 150px; height: 40px">Anmelden</button>
              </div>
            </div>
          </form> <!-- /.login-form -->
          
          <!-- 'Kein Account?'-Abfrage -->
          <hr class="my-4">

          <div class="row justify-content-center align-items-center text-center">
            <p style="margin-bottom: 16px;">Haben Sie noch kein Konto?</p>
            <a href="Registrierung.html"><button class="btn btn-light" style="width: 150px; height: 40px;">Registrieren</button></a>
          </div>
        </div>
      </div>
    </div> <!-- /.container -->

    <script>
      // Überprüfung, ob User angemeldet ist
      document.addEventListener("DOMContentLoaded", async () => {
        // Überprüfung, ob User angemeldet ist
        try{
          const response = await axios.post('http://localhost:8080/v1/user/start-session', {},
          {withCredentials: true});

          // Wenn die Anfrage erfolgreich ist (200 OK), geh zur Overview-Seite
          window.location.href = "../index.html";
        } catch(error) {
          if(error.code === "ERR_NETWORK"){
            console.log("Backend nicht erreichbar:" + error)
            let alertBox = document.getElementById('alertBox');
            // Alert sichtbar machen
            alertBox.style.display = 'block';
            // Bootstrap fade in Effekt hinzufügen
            alertBox.classList.add('show'); // Bootstrap Klasse 'show' hinzufügen
          }
        }
      });

      // Event-Listener für das Formular
      document.getElementById('login-form').addEventListener('submit', async function(event) {
        event.preventDefault(); // Verhindert das Neuladen der Webseite

        // Eingabewerte abrufen
        const email = document.getElementById('email').value;
        const password = document.getElementById('pwd').value;
        const remember_me = document.getElementById('remember_me').checked;
        try {
          // POST-Anfrage mit axios ans Backend senden
          const response = await axios.post('http://localhost:8080/v1/user/login', {
            email: email,
            password: password,
            remember_me: remember_me,
          },
          {
            withCredentials: true,
          },);
  
          // ToDo: Hier die Antwort verarbeiten
          if (response.status === 200) {
            window.location.href = "../index.html";
          }
        } catch (error) {
          if (error.response) {
            if (error.response.status === 400) {
              console.log("Invalid request body");
              alert("Invalid request body");
            } else if (error.response.status === 401) {
              console.log("Wrong credentials");
              alert("Email oder Passwort falsch!");
            } else if (error.response.status === 404) {
              console.log("User not found");
              alert("Trainer wurde nicht gefunden");
            } else if (error.response.status === 500) {
              console.log("Internal Server Error");
              alert("Internal Server Error");
            }
          } else {
            // Andere Fehler
            console.error("Netzwerkfehler:", error.message);
          }
        }
      });
    </script>
  </body>
</html>