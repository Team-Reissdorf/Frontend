<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <title>ComPeteHub</title>
  <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.css">
  <script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../node_modules/axios/dist/axios.js"></script>
</head>

<body>

  <script src="js/Navigation.js"></script> <!-- Navbar laden & einfügen -->

  <!-- Sortieren Dropdown und Sportler erstellen Button -->
  <div class="d-flex justify-content-between align-items-center m-2">
    <!-- Dropdown für Sortieren -->
    <div class="d-flex align-items-center">
      <label for="sorter" class="me-2">Sortieren:</label>
      <select id="sorter" class="form-select sorter" style="width: 200px;" required>
        <option value="fname">Vorname (A-Z)</option>
        <option value="lname">Nachname (A-Z)</option>
        <option value="birthdate">Geburtstag (Aufsteigend)</option>
      </select>
    </div>
    <div class="d-flex flex-row justify-content-between">
      <!-- Exportieren Button -->
      <button type="button" class="btn btn-light border border-2 ms-3" style="font-weight: bold;" data-bs-toggle="modal"
        data-bs-target="#exampleModal">Leistungsexport</button>

      <!-- einzelnen Sportler erstellen Button -->
      <a href="html/SportlerErstellen.html">
        <button class="btn btn-light border border-2 ms-3" style="font-weight: bold;">Sportler erstellen</button>
      </a>

      <!-- Bulkcreate Sportler erstellen Button -->
      <a href="html/SportlerErstellenBulk.html">
        <button class="btn btn-light border border-2 ms-3" style="font-weight: bold;">Sportler Massenerstellung</button>
      </a>
    </div>
  </div>
  <!-- Hier werden die Athleten angezeigt (Cards) -->
  <div class="container my-2 athlete-cards">
  </div>

  <!-- Modal für Erfolg & bereits erstellte Sportler-->
  <div class="modal fade modal-xl" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header d-flex-row justify-content-center text-center">
          <h1 class="modal-title fs-5 display-4 " id="exampleModalLabel"><strong>Leistungsexport</strong></h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button class="btn btn-light border border-2 ms-3" style="font-weight: bold;" id="export">Leistungen
            exportieren</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>

<script>
  // ToDo: Schauen wie response vom Backend ist ajdoiasidjaspidpiuwapwupodaksäödlaksädlökalskdlöasjdlkasökldjklöasjdklöjasödjaklsöjdköasjdöajsökdjasökdkölasj

  document.addEventListener("DOMContentLoaded", async () => {
    // Überprüfung, ob User angemeldet ist
    try {
      const response = await axios.post('http://localhost:8080/v1/user/start-session', {},
        { withCredentials: true });
      // Wenn die Anfrage erfolgreich ist (200 OK), mache weiter
    } catch (error) {
      //Falls Server nicht erreichbar ist
      if (error.response) {
        window.location.href = "html/Anmeldung.html";
      } else if (error.code == "ERR_NETWORK") {
        console.error("Backend nicht erreichbar:" + error)
        window.location.href = "html/BackendDown.html";
      } else if (error.response) {
        window.location.href = "html/Anmeldung.html";
      } else {
        // Andere Fehler
        console.error("Fehler: " + error)
      }
    }

    let athletes = [];
    try {
      // Athleten vom Server abrufen
      const response = await axios.get('http://localhost:8080/v1/athlete/get-all', {
        withCredentials: true,
      });

      athletes = response.data.athletes;
      sortCards(athletes, "fname");
      renderCards(athletes);
      modalFüllen(athletes);
    } catch (error) {
      console.error("Athletes could not load");
      alert("Sportler konnten nicht geladen werden");
      window.location.reload();
    }

    // Event Listener für Übungsänderung
    document.querySelector(".sorter").addEventListener("change", function (event) {
      const sortBy = event.target.value;
      sortCards(athletes, sortBy);
      renderCards(athletes);
    });

    // Event Listener für Export Button
    document.getElementById("export").addEventListener("click", async function (event) {
      const athletes = [];
      try {
        document.querySelectorAll(".athlete-checkbox:checked").forEach(checkbox => {
          athletes.push(parseInt(checkbox.dataset.athleteid));
        });

        if (athletes.length == 0) {
          console.error("Es wurden keine Sportler ausgewählt!");
          alert("Es wurden keine Sportler ausgewählt!");
          return
        } else {
          // POST-Anfrage an Backend senden
          const response = await axios.post('http://localhost:8080/v1/performance/export',
            {
              athlete_ids: athletes,
            },
            {
              withCredentials: true,
              responseType: "blob",
            });

          const url = window.URL.createObjectURL(new Blob([response.data]));
          const a = document.createElement("a");
          a.href = url;
          a.download = "performances.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById("exampleModal"));
        modal.hide();
      } catch (error) {
        if (error.response) {
          // ToDo: Response auswerten i1jadsdnöaseumei1jadsdnöaseumei1jadsdnöaseumei1jadsdnöaseumei1jadsdnöaseumei1jadsdnöaseumei1jadsdnöaseumei1jadsdnöaseume
          if (error.response.status === 400) {
            console.error("Invalid request body");
            alert("Invalid request body");
          } else if (error.response.status === 401) {
            window.location.href = "Anmeldung.html";
          } else if (error.response.status === 404) {
            console.error("Athlete or exercise does not exist");
            alert("Athlete or exercise does not exist");
          } else if (error.response.status === 409) {
            console.error("Performance limit reached");
            fehler409ModalFüllen();
          } else if (error.response.status === 500) {
            console.error("Internal Server Error");
            alert("Internal Server Error");
          }
        } else {
          // Andere Fehler
          console.error("Error:", error.message);
        }
      }
    });

    const selectAllCheckbox = document.getElementById("selectAll");
    const checkboxes = document.querySelectorAll(".athlete-checkbox");

    selectAllCheckbox.addEventListener("change", function () {
      checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
    });

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener("change", function () {
        selectAllCheckbox.checked = [...checkboxes].every(checkbox => checkbox.checked);
      });
    });
  });

  // Sortierfunktion
  function sortCards(athletes, criterion) {
    athletes.sort((a, b) => {
      if (criterion === 'birthdate') {
        return new Date(a.birth_date) - new Date(b.birth_date);
      } else if (criterion === 'fname') {
        return a.first_name.localeCompare(b.first_name);
      } else if (criterion === 'lname') {
        return a.last_name.localeCompare(b.last_name);
      }
    });
  }

  // Funktion zum Rendern der Karten
  async function renderCards(athletes) {
    const container = document.querySelector('.athlete-cards');
    container.innerHTML = "";

    const discipline_names = await getDisciplineNames();
    if (!discipline_names || discipline_names.length === 0) {
      console.error("Disziplinen konnten nicht geladen werden");
      return;
    }
    const exercises = await getOrderedExercises(discipline_names);

    for (const athlete of athletes) {
      const sexMap = { m: "Männlich", f: "Weiblich", d: "Divers" };
      const sex = sexMap[athlete.sex] || "";
      const birthdate = new Date(athlete.birth_date).toLocaleDateString("de-DE");

      const performanceEntries = await getPerformanceEntries(athlete.athlete_id);

      // Punkte berechnen (bronze = 1, silber = 2, gold = 3)
      let totalPoints = 0;
      const medalCells = exercises.map(exerciseGroup => {
        // Sammle alle Medaillen in dieser Disziplin
        const medals = exerciseGroup.map(exercise => {
          const perf = performanceEntries.find(p => p.exercise_id === exercise.exercise_id);
          return perf?.medal || "none";
        });

        // Beste Medaille wählen: gold > silver > bronze > none
        let bestMedal = "none";
        if (medals.includes("gold")) bestMedal = "gold";
        else if (medals.includes("silver")) bestMedal = "silver";
        else if (medals.includes("bronze")) bestMedal = "bronze";

        // Punkte dazu zählen
        if (bestMedal === "gold") totalPoints += 3;
        else if (bestMedal === "silver") totalPoints += 2;
        else if (bestMedal === "bronze") totalPoints += 1;

        return `<td style="padding: 8px 16px; font-size: 24px; min-width: 80px; text-align: center;">
          ${getMedalIcon(bestMedal)}
        </td>`;
      });

      // Zähle wie viele gültige Medaillen vorhanden sind
      const validMedalCount = medalCells.filter(cell =>
        cell.includes("🥇") || cell.includes("🥈") || cell.includes("🥉")
      ).length;

      const enoughMedals = validMedalCount === 4;

      // DSA-Medaille je nach Gesamtpunktzahl
      let dsaMedal = "none";
      let swimCert = athlete.swim_cert;
      if (enoughMedals && swimCert) {
        if (totalPoints >= 11) dsaMedal = "gold";
        else if (totalPoints >= 8) dsaMedal = "silver";
        else if (totalPoints >= 4) dsaMedal = "bronze";
      }

      const swimIcon = swimCert ? '✅' : '❌';

      // Gesamte Zeile: DSA zuerst
      const medalRow = `
        <td style="padding: 8px 16px; font-size: 24px; min-width: 80px; text-align: center;">${getMedalIcon(dsaMedal)}</td>
        ${medalCells.join("")}
        <td style="padding: 8px 16px; font-size: 24px; min-width: 80px; text-align: center;">${swimIcon}</td>  
      `;

      const cardHTML = `
      <div class="row" style="padding-bottom: 24px;">
        <div class="p-4 text-center bg-body-tertiary rounded-4 border border-2 w-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0" style="margin-left: 24px; text-align: left;">${athlete.first_name} ${athlete.last_name}</h4>
              <h6 class="mb-0" style="margin-left: 24px; text-align: left;">${birthdate} ${sex}</h6>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <table>
                <thead>
                  <tr>
                    <th style="padding: 8px 16px; min-width: 60px;">DSA</th>
                    ${discipline_names.map(d => `<th style="padding: 8px 16px; min-width: 60px;">${d}</th>`).join("")}
                    <th style="padding: 8px 16px; min-width: 60px;">Schwimmnachweis</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    ${medalRow}
                  </tr>
                </tbody>
              </table>
            </div>
            <div>
              <a href="html/SportlerBearbeiten.html?id=${athlete.athlete_id}"><button class="btn btn-light rounded-3 border border-2 fw-bold mx-2 my-2">Bearbeiten</button></a>
              <a href="html/Leistungsuebersicht.html?id=${athlete.athlete_id}"><button class="btn btn-light rounded-3 border border-2 fw-bold mx-2 my-2">Leistungsübersicht</button></a>
              <button class="btn btn-light rounded-3 border border-2 delete-btn fw-bold mx-2 my-2" data-id="${athlete.athlete_id}">Löschen</button>
            </div>
          </div>
        </div>
      </div>
      `;
      container.insertAdjacentHTML('beforeend', cardHTML);
    }

    // Event Listener fürs Löschen
    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const athleteId = button.getAttribute('data-id');

        if (confirm('Möchten Sie diesen Sportler wirklich löschen?')) {
          try {
            await axios.delete(`http://localhost:8080/v1/athlete/delete/${athleteId}`, { withCredentials: true });

            const index = athletes.findIndex(a => a.athlete_id === parseInt(athleteId));
            if (index !== -1) {
              athletes.splice(index, 1);
            }

            renderCards(athletes);
          } catch (error) {
            console.error('Fehler beim Löschen des Sportlers:', error);
            alert('Löschen des Sportlers fehlgeschlagen.');
          }
        }
      });
    });
  }

  function modalFüllen(response) {
    const modalBody = document.getElementsByClassName("modal-body")[0];
    const modalTitle = document.getElementById("exampleModalLabel");

    //bereits vorhandene Sportler anzeigen
    let athleteListHTML = `
      <p>Wählen Sie bitte die Sportler aus, von denen Sie die Leistungen exportieren möchten!</p>
      <p>Es wird eine CSV-Datei erstellt, die mit diesem Format:</p>
      <p>Nachname, Vorname, Geschlecht, Geburtstag, Übung, Kategorie, Datum, Ergebnis, Punkte</p>
    `;
    athleteListHTML += `
      <table class="table">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Name</th>
            <th>Geburtsdatum</th>
            <th>E-Mail</th>
            <th>Geschlecht</th>
          </tr>
        </thead>
        <tbody>
    `;
    if (response !== null) {
      id = 0
      response.forEach(athlete => {
        const birthdate = athlete.birth_date.split("T")[0].split('-')[2] + '.' + athlete.birth_date.split("T")[0].split('-')[1] + '.' + athlete.birth_date.split("T")[0].split('-')[0];
        var sex = "";
        if (athlete.sex === "m") {
          sex = 'Männlich';
        } else if (athlete.sex === "f") {
          sex = 'Weiblich';
        } else if (athlete.sex === "d") {
          sex = 'Divers';
        }
        athleteListHTML += `
          <tr>
            <td><input type="checkbox" class="athlete-checkbox" value="1" data-athleteid=${athlete.athlete_id} id="helloWorld_${id}"></td>
            <td><strong>${athlete.first_name} ${athlete.last_name}</strong></td>
            <td>${birthdate}</td>
            <td>${athlete.email}</td>
            <td>${sex}</td>
          </tr>
        `;
        id++;
      });
    }
    athleteListHTML += `
        </tbody>
      </table>
    `;

    // Setze den Inhalt im Modal
    modalTitle.innerHTML = "<strong>Leistungsexport<strong>";
    modalBody.innerHTML = athleteListHTML;
  }

  async function getPerformanceEntries(athleteId) {
    try {
      year = new Date().getFullYear();
      const response = await axios.get(`http://localhost:8080/v1/performance/get/${athleteId}?since=${year}-01-01`, {
        withCredentials: true
      });
      return response.data.performance_entries;
    } catch (error) {
      console.error(`Fehler beim Abrufen der Leistungen für Athlet ${athleteId}:`, error);
      return [];
    }
  }

  async function getDisciplineNames() {
    try {
      const response = await axios.get('http://localhost:8080/v1/discipline/get-all', { withCredentials: true });
      return response.data.discipline_names;
    } catch (error) {
      alert("Etwas ist schief gelaufen!");
      console.error("Get disciplines went wrong");
      return [];
    }
  }

  async function getExercises(discipline_name) {
    try {
      const response = await axios.get(`http://localhost:8080/v1/exercise/get/${discipline_name}`, { withCredentials: true });
      return response.data.exercises;
    } catch (error) {
      console.error("Fehler beim Abrufen der Übungen:", error);
      return [];
    }
  }

  function getMedalIcon(medal) {
    const medalMap = {
      gold: '🥇',
      silver: '🥈',
      bronze: '🥉',
      none: '❌'
    };
    return medalMap[medal] || medalMap.none;
  }

  async function getOrderedExercises(disciplineNames) {
    const exercises = [];

    for (const name of disciplineNames) {
      const list = await getExercises(name);
      if (list.length > 0) {
        exercises.push(list);
      } else {
        console.warn(`Keine Übung für Disziplin "${name}" gefunden`);
      }
    }

    return exercises;
  }
</script>